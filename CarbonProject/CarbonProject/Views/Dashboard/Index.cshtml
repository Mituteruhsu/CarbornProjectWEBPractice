@model CarbonProject.Controllers.DashboardController.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
}


<h2 class="text-center">企業碳排放數據與目標</h2>
<h6 class="text-center">
    平均減碳目標比例：@Model.AvgReductionPercent.ToString("F2")% / 平均目標排放量：@Model.AvgTotalEmission.ToString("N0") 噸
</h6>

<div class="row g-4">
    <!-- 年度平均統計卡片 -->
    <div class="col-xl">
        <div class="card shadow-sm border-1 text-white h-100">
            <div class="card-body">
                <h6 class="card-title text-uppercase fw-bold">企業平均排放統計</h6>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>年份</th>
                            <th>參與公司數量</th>
                            <th>該年總排放量 (Sum)</th>
                            <th>跨年度平均 (Avg of Sum)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.YearlyEmissionAverages)
                        {
                            <tr>
                                <td>@item.Year</td>
                                <th>@item.CompanyCount</th>
                                <td>@item.TotalEmissionSum.ToString("N4")</td>
                                <td>@item.AverageAcrossYears.ToString("N4")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- 排放量圖表卡片 -->
    <div class="col-xl">
        <div class="card shadow-sm border-1 text-white h-100">
            <div class="card-body">
                <h6 class="card-title text-uppercase fw-bold">參與企業平均區勢</h6>
                <!-- 隱藏資料給外部 JS 使用 -->
                <div id="yearlyData" style="display:none">
                    @Model.AvgTotalEmission.ToString("N0")
                    @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.YearlyEmissionAverages))
                </div>
                <canvas class="my-4 w-100"
                        id="emissionChart"
                        width="900"
                        height="380"></canvas>                
            </div>
        </div>
    </div>
</div>

<!-- 平均減碳目標公式 -->
<div class="card my-3 shadow-sm text-center">
    <div class="card-header bg-success text-white">
        平均減碳目標比例計算公式
    </div>
    <div class="card-body">
        <p class="card-text">
            <strong>平均減碳目標比例</strong>（Reduction Percent）是用來衡量企業相較於基準年，
            在目標年度預計減少的碳排放比例。
        </p>

        <p class="card-text fw-bold">
            <math xmlns="http://www.w3.org/1998/Math/MathML" display="block" style="font-family: monospace; font-size: 1.1em;">
                <mrow>
                    <mi>減碳目標比例</mi>
                    <mo>=</mo>
                    <mfrac>
                        <mrow>
                            <mi>基準年排放量</mi>
                            <mo>-</mo>
                            <mi>目標年排放量</mi>
                        </mrow>
                        <mi>基準年排放量</mi>
                    </mfrac>
                    <mo>&#x00D7;</mo>
                    <mn>100</mn>
                    <mo>%</mo>
                </mrow>
            </math>
        </p>
        <p class="card-text">
            ▸ 基準年排放量（BaselineEmission）＝ 10,000 噸<br>
            ▸ 目標年排放量（TargetEmission）＝ 8,000 噸<br>
            ➜ 平均減碳目標比例 ＝ (10,000 − 8,000) ÷ 10,000 × 100% ＝ <strong>20%</strong>
        </p>
    </div>
</div>

<hr />

@* <!-- 公司排放量列表 -->
<div class="card my-3 shadow-sm">
    <div class="card-header bg-primary text-white">
        公司排放量列表
        <a asp-controller="Carbon" asp-action="CreateEmission" class="btn btn-light btn-sm float-end">新增排放量</a>
    </div>
    <div class="card-body table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>公司ID</th>
                    <th>年度</th>
                    <th>範疇1</th>
                    <th>範疇2</th>
                    <th>範疇3</th>
                    <th>總排放量</th>
                    <th>來源</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in Model.CompanyEmissions)
                {
                    <tr>
                        <td>@e.CompanyId</td>
                        <td>@e.Year</td>
                        <td>@e.Scope1Emission</td>
                        <td>@e.Scope2Emission</td>
                        <td>@e.Scope3Emission</td>
                        <td>@e.TotalEmission</td>
                        <td>@e.Source</td>
                        <td>
                            <a asp-controller="Carbon" asp-action="EditEmission" asp-route-id="@e.EmissionId" class="btn btn-sm btn-warning">編輯</a>
                            <form asp-controller="Carbon" asp-action="DeleteEmission" method="post" style="display:inline">
                                <input type="hidden" name="id" value="@e.EmissionId" />
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('確定要刪除嗎？')">刪除</button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- 公司減碳目標列表 -->
<div class="card my-3 shadow-sm">
    <div class="card-header bg-success text-white">
        公司減碳目標列表
        <a asp-controller="Carbon" asp-action="CreateTarget" class="btn btn-light btn-sm float-end">新增減碳目標</a>
    </div>
    <div class="card-body table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>公司ID</th>
                    <th>基準年</th>
                    <th>目標年</th>
                    <th>基準排放量</th>
                    <th>目標排放量</th>
                    <th>減碳百分比</th>
                    <th>說明</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model.CompanyEmissionTargets)
                {
                    <tr>
                        <td>@t.CompanyId</td>
                        <td>@t.BaselineYear</td>
                        <td>@t.TargetYear</td>
                        <td>@t.BaselineEmission</td>
                        <td>@t.TargetEmission</td>
                        <td>@t.ReductionPercent</td>
                        <td>@t.Description</td>
                        <td>
                            <a asp-controller="Carbon" asp-action="EditTarget" asp-route-id="@t.TargetId" class="btn btn-sm btn-warning">編輯</a>
                            <form asp-controller="Carbon" asp-action="DeleteTarget" method="post" style="display:inline">
                                <input type="hidden" name="id" value="@t.TargetId" />
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('確定要刪除嗎？')">刪除</button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div> *@