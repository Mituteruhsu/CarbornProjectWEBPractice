@model CarbonProject.Models.MembersViewModel

@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "會員詳情";
}

<div class="row">
    <!-- 左上：頭像卡片 -->
    <!-- 右上：基本資料卡片 -->
    <div class="col-md-12 mb-3">
        @if (TempData["NewPassword"] != null)
        {
            <div class="alert alert-warning">
                <strong>新密碼：</strong>
                <span style="font-family:monospace">@TempData["NewPassword"]</span>
                <br />
                <small>請立即通知使用者並請他登入後變更密碼。</small>
            </div>
        }
        <div class="card border-success bg-transparent">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <div>基本資料
                    <!-- 重設密碼 -->
                    <form asp-controller="Users" asp-action="ResetPassword" asp-route-id="@Model.MemberId" method="post" class="d-inline" onsubmit="return confirm('確定要重設密碼嗎？');">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-warning ms-3 px-2 py-0">重設密碼</button>
                    </form>
                </div>
                <div>
                    <a href="@Url.Action("Edit", new { id = Model.MemberId })" class="btn btn-sm btn-outline-light">編輯</a>
                    <a href="@Url.Action("Index")" class="btn btn-sm btn-outline-light">返回列表</a>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-0">
                    <div class="col-md-4 d-flex justify-content-center align-items-center">
                        @if (!string.IsNullOrEmpty(Model.ProfileImage))
                        {
                            <img src="~/img_profile/@Model.ProfileImage" class="img-thumbnail" style="width:150px; height:150px;" alt="Profile Image">
                        }
                        else
                        {
                            <div class="bg-secondary text-white img-thumbnail d-flex align-items-center justify-content-center"
                                 style="width:150px; height:150px; font-size: 2rem;">
                                N/A
                            </div>
                        }
                    </div>
                    <div class="col-md-8">
                        <table class="table table-borderless mb-0">
                            <tbody>
                                <tr>
                                    <th>帳號</th>
                                    <td>@Model.Username
                                        <!-- 刪除會員 -->
                                        <form asp-controller="Users" asp-action="DeleteMember" asp-route-id="@Model.MemberId" method="post" class="d-inline" onsubmit="return confirm('確定要刪除此會員嗎？');">
                                        @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-outline-danger ms-2 text-nowrap" style="padding: .1rem .5rem; font-size: .75rem;">刪除會員</button>
                                        </form>
                                        </td>
                                </tr>
                                <tr><th>Email</th><td>@Model.Email</td></tr>
                                <tr><th>姓名</th><td>@Model.FullName</td></tr>
                                <tr><th>生日</th><td>@(Model.Birthday?.ToString("yyyy-MM-dd") ?? "未填寫")</td></tr>
                                <tr>
                                    <th>性別</th>
                                    <td>
                                        @(string.IsNullOrWhiteSpace(Model.Gender) ? "未填寫" : Model.Gender.Trim() == "M" ? "男" : "女")
                                    </td>
                                </tr>
                                <tr><th>地址</th><td>@(string.IsNullOrWhiteSpace(Model.Address) ? "未填寫" : Model.Address)</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- 左下：其他資訊卡片 -->
    <div class="col-md-6 mb-3">
        <div class="card h-100 bg-transparent border-success">
            <div class="card-header bg-success text-white">其他資訊</div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tbody>
                        <tr>
                            <th>啟用狀態</th>
                            <td>
                                <span class="badge @(Model.IsActive ? "bg-success" : "bg-danger")">
                                    @(Model.IsActive ? "啟用" : "停用")
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Email / Phone 驗證</th>
                            <td>
                                <span class="badge @(Model.EmailConfirmed ? "bg-success" : "bg-secondary")">Email</span>
                                <span class="badge @(Model.PhoneConfirmed ? "bg-success" : "bg-secondary")">Phone</span>
                            </td>
                        </tr>
                        <tr><th>所屬公司</th><td>@(Model.Company?.CompanyName ?? "未設定")</td></tr>
                        <tr class="align-middle">
                            <th>角色</th>
                            <td>
                                @foreach (var ur in Model.UserRoles)
                                {
                                    <span class="badge bg-primary me-1">@ur.Role.RoleName</span>
                                }
                                <!-- 設定角色 -->
                                <a asp-controller="Users" asp-action="AssignRole" asp-route-id="@Model.MemberId" class="btn btn-outline-primary text-nowrap" style="margin: .1rem .0rem .0rem .0rem; padding: .1rem .5rem; font-size: .75rem;">設定角色</a>
                            </td>
                        </tr>
                        <tr><th>會員等級</th><td>@(Model.MembershipLevel ?? "無")</td></tr>
                        <tr><th>積分</th><td>@Model.Points</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 右下：狀態與紀錄卡片 -->
    <div class="col-md-6 mb-3">
        <div class="card h-100 bg-transparent border-success">
            <div class="card-header bg-success text-white">狀態與紀錄</div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tbody>

                        <tr><th>最後登入</th><td>@(Model.LastLoginAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm") ?? "未登入")</td></tr>
                        <tr><th>最後登出</th><td>@(Model.LastLogoutAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm") ?? "未紀錄")</td></tr>
                        <tr><th>最後登入錯誤</th><td>@(Model.LastFailedLoginAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm") ?? "無")</td></tr>
                        <tr><th>登入錯誤次數</th><td>@Model.FailedLoginAttempts</td></tr>
                        <tr><th>建立時間</th><td>@Model.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td></tr>
                        <tr><th>更新時間</th><td>@Model.UpdatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>