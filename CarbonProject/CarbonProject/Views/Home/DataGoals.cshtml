@model CarbonProject.Models.DataGoalsViewModel
@using Newtonsoft.Json
@{
    ViewData["Title"] = "數據與目標";
}

<section class="text-center py-10 bg-gray-50">
    <h1 class="text-3xl font-bold text-green-700">企業碳排放數據與目標</h1>
    <p class="text-gray-600 mt-2">年度排放變化與減碳進度</p>
</section>

<div class="max-w-5xl mx-auto mt-8 px-6">
    <!-- 折線圖 -->
    <canvas id="emissionChart" height="100"></canvas>

    <!-- 進度條 -->
    <div class="mt-10 text-center">
        <h2 class="text-xl font-semibold text-gray-700 mb-3">目標達成進度</h2>
        <div class="w-full bg-gray-200 rounded-full h-6 mb-4">
            <div class="bg-green-600 h-6 rounded-full" style="width:@(Model.Goal.ProgressRate * 100)%"></div>
        </div>
        <p>目前排放量：@Model.Goal.CurrentEmission 噸 / 目標：@Model.Goal.TargetEmission 噸</p>
    </div>

    <!-- 下載 PDF 報告 -->
    <div class="text-center mt-10">
        <a href="/DataGoals/DownloadReport" class="btn btn-outline-success px-6 py-3">
            📄 下載年度碳排放報告
        </a>
    </div>
</div>

<!-- Chart.js 折線圖 Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = @Html.Raw(JsonConvert.SerializeObject(Model.AnnualEmissions.Select(e => e.Year)));
    const data = @Html.Raw(JsonConvert.SerializeObject(Model.AnnualEmissions.Select(e => e.Emission)));
    const targetValue = @Model.Goal.TargetEmission;

    const ctx = document.getElementById('emissionChart');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '年度碳排放量 (噸)',
                    data: data,
                    borderColor: '#16a34a',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.3,
                    pointBackgroundColor: '#16a34a',
                    pointStyle: 'circle',   // 圓點
                    pointRadius: 5          // 點大小
                },
                {
                    label: '目標值',
                    data: Array(data.length).fill(targetValue),
                    borderColor: 'red',
                    borderWidth: 2,
                    borderDash: [6, 4],      // 虛線
                    fill: false,
                    pointStyle: 'circle',    // 圓點
                    pointRadius: 3           // 小圓點
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#333',
                        usePointStyle: true,    // 改為線條或點形狀
                        pointStyle: 'line',     // 小線段
                        padding: 20,            // 調整間距
                        boxWidth: 40            // 控制線條寬度
                    }
                },
                title: {
                    display: true,
                    text: '年度碳排放趨勢',
                    color: '#16a34a',
                    font: { size: 18, weight: 'bold' }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '碳排放量 (噸)',
                        color: '#444'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '年份',
                        color: '#444'
                    }
                }
            }
        }
    });
</script>